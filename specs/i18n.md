# Internationalization (i18n) Implementation

## Overview
The Kossabos platform provides a complete internationalization system for game localization, storing translations in DynamoDB with in-memory caching for performance.

## Architecture

### Server Components

#### I18nService (`apps/server/src/services/i18n-service.ts`)
Core service handling translation storage and retrieval:

- **Storage**: DynamoDB with optimized key structure
- **Caching**: In-memory cache with 15-minute TTL
- **Versioning**: Automatic version generation for cache invalidation

#### Data Models (`apps/server/src/models/index.ts`)
```typescript
interface I18nData {
  locale: string;        // e.g., "en-US", "es-ES" 
  appId?: string;        // Game/app identifier
  translations: Record<string, string>;  // Key-value translation pairs
  version: string;       // Auto-generated version for caching
  lastUpdated: string;   // ISO timestamp
}
```

#### DynamoDB Schema
**Primary Key Structure**:
- `PK`: `I18N#{appId}` (partition key)
- `SK`: `LOCALE#{locale}` (sort key)

**GSI1 Structure** (for querying by locale):
- `GSI1PK`: `LOCALE#{locale}`
- `GSI1SK`: `APP#{appId}`

### API Endpoints (`apps/server/src/routes/i18n.ts`)

All endpoints are under `/v1/protected/i18n` and require authentication.

#### Core Operations
- `GET /:appId/:locale` - Retrieve translations for app/locale
- `POST /:appId/:locale` - Store translations (requires `translations` object in body)
- `DELETE /:appId/:locale` - Remove translations for app/locale

#### Metadata & Discovery
- `GET /:appId/locales` - List available locales for an app
- `GET /:appId/:locale/metadata` - Get version and last updated info without translations

### Caching Strategy

#### Cache Keys (`apps/server/src/utils/cache/keys.ts`)
- Format: `translations:{appId}:{locale}`
- TTL: 15 minutes
- Automatic invalidation on updates/deletes

#### Cache Operations
- **Preloading**: Bulk cache warming for performance
- **Pattern Matching**: Support for cache key patterns with wildcards
- **Cleanup**: Automatic expired entry removal

### Client Integration

#### Core Client (`packages/core/src/client/client.ts`)
```typescript
public t = (key: string, defaultValue: string) => this.localization.t(key) ?? defaultValue;
```

#### Localization Class (`packages/core/src/client/localization.ts`)
Basic placeholder implementation - currently returns `null` for all keys.

### Example Usage

#### Locale File Structure
```json
{
  "title": "Game Title",
  "description": "Game description",
  "settings": {
    "difficulty": "Difficulty Level",
    "players": "Number of Players"
  },
  "messages": {
    "welcome": "Welcome {username}!",
    "game-over": "Game Over"
  }
}
```

#### Example Games with i18n
- **Tic Tac Toe**: `packages/examples/src/classics/tic-tac-toe/locales/en-US.json`
- **Poetry Slam**: `packages/examples/src/word-games/poetry-slam/locales/en-US.json`
- **Yatzy**: `packages/examples/src/dice-games/yatzy/locales/en-US.json`

## Error Handling

### Service-Level Errors
- Empty translations returned for missing app/locale combinations
- Automatic fallback to prevent application crashes
- Comprehensive error logging for troubleshooting

### API Response Format
```typescript
interface I18nResponse {
  success: boolean;
  data?: {
    translations?: Record<string, string>;
    locale?: string;
    appId?: string;
    version?: string;
    lastUpdated?: string;
  };
  error?: string;
  timestamp: string;
}
```
